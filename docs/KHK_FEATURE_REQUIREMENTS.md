# KHK公開機能 要件定義書

## 1. 概要

### 1.1 目的
ADreamFactory Portalのホーム画面「おすすめプロダクト」セクションにおいて、LarkBase上の「KHKで公開」チェックボックスがONになっているコンテンツのみを表示する機能を実装する。

### 1.2 スコープ

| フェーズ | 機能 | 優先度 |
|---------|------|--------|
| Phase 1 | KHKで公開フラグによるフィルタリング | 必須 |
| Phase 1 | YouTube優先、紹介動画フォールバック表示 | 必須 |
| Phase 2 | 放送開始日時による表示制御 | 次期 |

### 1.3 関連システム

```
┌─────────────────────────────────────────────────────────────┐
│                    ADreamFactory Portal                     │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │   LarkBase      │    │        Frontend (Next.js)       │ │
│  │   多元表        │───▶│  ┌───────────────────────────┐  │ │
│  │                 │    │  │ おすすめプロダクトセクション │  │ │
│  │ ・KHKで公開     │    │  │ - KHK公開コンテンツのみ   │  │ │
│  │ ・YouTubeリンク │    │  │ - YouTube優先表示         │  │ │
│  │ ・紹介動画      │    │  │ - 放送開始日時制御        │  │ │
│  │ ・放送開始日時  │    │  └───────────────────────────┘  │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 機能要件

### 2.1 KHK公開フィルタリング（Phase 1）

#### 2.1.1 データソース

| フィールド名 | タイプ | 説明 |
|-------------|--------|------|
| KHKで公開 | チェックボックス | ONの場合のみおすすめセクションに表示 |
| YouTubeリンク | URL/テキスト | YouTube動画URL（優先表示） |
| 紹介動画 | 添付ファイル/URL | 紹介動画（YouTubeがない場合のフォールバック） |
| 放送開始日時 | 日時 | スケジュール配信開始時刻（Phase 2） |

#### 2.1.2 表示ロジック

```
IF KHKで公開 == true THEN
  IF YouTubeリンク != 空 THEN
    表示: YouTube埋め込み
  ELSE IF 紹介動画 != 空 THEN
    表示: 紹介動画プレイヤー
  ELSE
    表示しない（動画コンテンツなし）
  END IF
ELSE
  表示しない（KHK非公開）
END IF
```

#### 2.1.3 UI仕様

- **位置**: ホーム画面の最上部（現在の「おすすめ」セクション）
- **サイズ**: フル幅、16:9アスペクト比
- **複数コンテンツ**: 横スクロール対応（カルーセル形式）
- **表示順**: 放送開始日時 > 作成日時 の降順

### 2.2 放送開始日時制御（Phase 2）

#### 2.2.1 表示条件

```
IF 放送開始日時 != 空 THEN
  IF 現在時刻 >= 放送開始日時 THEN
    表示: 動画コンテンツ（通常表示）
  ELSE
    表示: カウントダウンタイマー + サムネイル
  END IF
ELSE
  表示: 動画コンテンツ（即時公開）
END IF
```

#### 2.2.2 カウントダウン表示

- 放送開始日時までの残り時間を表示
- リアルタイム更新（1秒間隔）
- 開始時刻到達で自動再読み込み/表示切替

---

## 3. 非機能要件

### 3.1 パフォーマンス

| 要件 | 目標値 |
|------|--------|
| API応答時間 | < 500ms |
| 初回表示 | < 2秒 |
| キャッシュ有効期限 | 60秒 |

### 3.2 互換性

- 既存の「おすすめ」セクションとの後方互換性維持
- KHK公開コンテンツがない場合は従来のおすすめ表示にフォールバック

### 3.3 セキュリティ

- 認証不要（公開コンテンツのみ）
- YouTube埋め込みはrel=0, modestbranding=1適用

---

## 4. データモデル

### 4.1 LarkBaseフィールド追加

```typescript
// 新規追加フィールド
interface KHKFields {
  'KHKで公開': boolean;           // チェックボックス
  'YouTubeリンク': string;         // URL/テキスト
  '紹介動画': Attachment[];        // 添付ファイル
  '放送開始日時': number;          // 日時（ミリ秒）
}
```

### 4.2 Event型拡張

```typescript
interface Event {
  // 既存フィールド
  id: string;
  title: string;
  description: string;
  // ...

  // KHK機能追加フィールド
  khk_published: boolean;          // KHKで公開フラグ
  khk_youtube_url?: string;        // KHK用YouTubeリンク
  khk_intro_video?: string;        // KHK用紹介動画URL
  broadcast_start_at?: string;     // 放送開始日時（ISO8601）
}
```

---

## 5. API設計

### 5.1 新規エンドポイント

```
GET /api/khk-featured
```

**レスポンス:**
```json
{
  "success": true,
  "events": [
    {
      "id": "recXXX",
      "title": "KHK公開コンテンツ",
      "video_type": "youtube" | "intro",
      "video_url": "https://...",
      "thumbnail": "https://...",
      "broadcast_start_at": "2025-01-15T19:00:00Z",
      "is_live": true
    }
  ]
}
```

### 5.2 既存API拡張

`GET /api/events` にKHKフィールドを追加

---

## 6. 画面設計

### 6.1 おすすめプロダクトセクション（リニューアル）

```
┌────────────────────────────────────────────────────────────┐
│ ⭐ おすすめプロダクト                                       │
├────────────────────────────────────────────────────────────┤
│ ┌──────────────────────────────────────────────────────┐   │
│ │                                                      │   │
│ │              [YouTube埋め込み/動画プレイヤー]         │   │
│ │                     16:9 アスペクト比                │   │
│ │                                                      │   │
│ ├──────────────────────────────────────────────────────┤   │
│ │ 📺 KHK公開コンテンツタイトル                          │   │
│ │ 説明テキスト...                                       │   │
│ └──────────────────────────────────────────────────────┘   │
│                                                            │
│ ◀ ● ● ● ▶  (複数ある場合はカルーセル)                      │
└────────────────────────────────────────────────────────────┘
```

### 6.2 カウントダウン表示（Phase 2）

```
┌────────────────────────────────────────────────────────────┐
│ ┌──────────────────────────────────────────────────────┐   │
│ │                  [サムネイル画像]                     │   │
│ │                                                      │   │
│ │    ┌────────────────────────────────────────┐        │   │
│ │    │   🔴 配信開始まで                       │        │   │
│ │    │      02:15:30                          │        │   │
│ │    │   2025/01/15 19:00 開始予定            │        │   │
│ │    └────────────────────────────────────────┘        │   │
│ │                                                      │   │
│ └──────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────┘
```

---

## 7. 実装計画

### Phase 1: 基本機能（必須）

1. **LarkBaseクライアント拡張**
   - KHKフィールドのマッピング追加
   - KHK公開コンテンツ取得関数

2. **API実装**
   - `/api/khk-featured` 新規作成
   - `/api/events` KHKフィールド追加

3. **コンポーネント作成**
   - `KHKFeaturedSection.tsx` 新規作成
   - YouTube埋め込み/動画プレイヤー切り替えロジック

4. **ホーム画面統合**
   - `HomeClient.tsx` 修正
   - おすすめセクションをKHK版に置換

### Phase 2: スケジュール機能

1. **放送開始日時処理**
   - 日時比較ロジック
   - カウントダウンコンポーネント

2. **リアルタイム更新**
   - タイマー実装
   - 自動表示切替

---

## 8. テスト計画

### 8.1 単体テスト

| テストケース | 期待結果 |
|-------------|----------|
| KHK公開=true, YouTube有 | YouTube埋め込み表示 |
| KHK公開=true, YouTube無, 紹介動画有 | 紹介動画表示 |
| KHK公開=true, 両方無 | 非表示 |
| KHK公開=false | 非表示 |
| 放送開始日時=未来 | カウントダウン表示 |
| 放送開始日時=過去 | 通常表示 |

### 8.2 結合テスト

- LarkBaseからのデータ取得確認
- 複数KHKコンテンツのカルーセル動作
- レスポンシブ表示確認

---

## 9. リスクと対策

| リスク | 対策 |
|--------|------|
| LarkBaseフィールド名変更 | フィールド名を環境変数化 |
| YouTube API制限 | 埋め込み方式で回避 |
| 動画再生エラー | エラーハンドリング+フォールバック表示 |

---

## 10. 承認

| 項目 | 担当 | 日付 |
|------|------|------|
| 要件定義 | - | 2025/01/14 |
| 設計レビュー | - | - |
| 実装完了 | - | - |
| テスト完了 | - | - |

---

*このドキュメントは開発進行に応じて更新されます。*
