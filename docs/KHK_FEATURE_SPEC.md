# KHK公開機能 要件定義書

## 1. 概要

### 1.1 目的
AI Dream Factory Portalのホーム画面上部「おすすめプロダクト」枠にて、LarkBase開発テーブルの「KHKで公開」フラグが有効なプロダクトを特別表示する機能を実装する。

### 1.2 スコープ
- **Phase 1**: KHK公開フィルタリングとYouTube/紹介動画の優先表示
- **Phase 2**: 放送開始日時による動画切り替え機能

---

## 2. 用語定義

| 用語 | 説明 |
|------|------|
| KHK | 「神回確定」の略称。特別におすすめするコンテンツを示すフラグ |
| KHKで公開 | LarkBaseのチェックボックスフィールド。trueの場合、おすすめプロダクトとして表示 |
| YouTubeリンク | YouTubeの動画URL（ライブ配信含む） |
| 紹介動画 | Lark Driveにアップロードされた動画ファイル |
| 放送開始日時 | YouTubeライブなどの配信開始予定時刻 |

---

## 3. 機能要件

### 3.1 Phase 1: KHK公開フィルタリング

#### FR-001: KHKフィルタリング
- **説明**: 「KHKで公開」がtrueのプロダクトのみをおすすめ枠に表示
- **優先度**: 高
- **受入条件**:
  - 通常のプロダクト一覧とは別のAPIエンドポイントで取得
  - KHKで公開=trueのプロダクトのみ返却
  - 複数ある場合は作成日時の新しい順にソート

#### FR-002: 動画優先表示ロジック
- **説明**: YouTubeリンク → 紹介動画 の優先順で動画を表示
- **優先度**: 高
- **受入条件**:
  - YouTubeリンクが設定されている場合: YouTube埋め込みプレイヤーを表示
  - YouTubeリンクが空で紹介動画がある場合: Lark Drive動画を表示
  - どちらもない場合: プレースホルダー表示

#### FR-003: YouTube埋め込み対応
- **説明**: YouTubeリンクからvideo IDを抽出し、埋め込みプレイヤーを表示
- **優先度**: 高
- **受入条件**:
  - 通常のYouTube URL対応 (`youtube.com/watch?v=xxx`)
  - 短縮URL対応 (`youtu.be/xxx`)
  - ライブ配信URL対応 (`youtube.com/live/xxx`)
  - レスポンシブな16:9アスペクト比

### 3.2 Phase 2: 放送開始日時による動画切り替え

#### FR-004: 放送開始日時判定
- **説明**: 放送開始日時フィールドの日時を判定し、動画表示を制御
- **優先度**: 中
- **受入条件**:
  - 放送開始日時が設定されている場合、その時刻以降にのみ動画を表示
  - 放送開始日時前はカウントダウン表示
  - 放送開始日時が過ぎたらYouTubeリンクまたは紹介動画を表示

#### FR-005: リアルタイム切り替え
- **説明**: 放送開始時刻になったタイミングで自動的に動画表示に切り替え
- **優先度**: 中
- **受入条件**:
  - クライアントサイドでタイマー監視
  - 放送開始5分前から「まもなく開始」表示
  - 放送開始時に自動リフレッシュまたはUI更新

---

## 4. LarkBaseフィールド定義

### 4.1 既存フィールド
| フィールド名 | フィールドID | 型 | 説明 |
|-------------|--------------|-----|------|
| Project Name | fld7UBgkaI | Text | プロダクト名 |
| 紹介動画 | fld5nHsAZ3 | Attachment | Lark Drive動画 |
| ポータルで公開 | fldPCt8RhZ | Checkbox | 一般公開フラグ |
| Status | fldEsYRWlS | SingleSelect | 開発ステータス |
| 製品デプロイURL | fldpe4GH5K | URL | 製品リンク |
| Assignee | fldck1MQlv | SingleSelect | 開発者 |
| Notes | fldPTmpwQa | Text | 説明 |
| Created Date | fldeIdyTE8 | CreatedTime | 作成日 |

### 4.2 新規追加フィールド（LarkBase側で作成済み）
| フィールド名 | フィールドID | 型 | 説明 |
|-------------|--------------|-----|------|
| KHKで公開 | （要確認） | Checkbox | おすすめプロダクト表示フラグ |
| YouTubeLink | （要確認） | URL | YouTube動画リンク |
| 放送開始日時 | （要確認） | DateTime | 配信開始予定時刻 |

---

## 5. 非機能要件

### NFR-001: パフォーマンス
- おすすめプロダクトの取得は2秒以内
- YouTube埋め込みはlazy load対応

### NFR-002: ブラウザ対応
- Chrome, Safari, Firefox, Edge最新版
- iOS Safari, Android Chrome対応

### NFR-003: レスポンシブ対応
- モバイル（〜640px）
- タブレット（641〜1024px）
- デスクトップ（1025px〜）

---

## 6. システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────┐
│                     Frontend (Next.js 15)                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  HomeClient.tsx                                              │
│  ├─ FeaturedProduct (おすすめプロダクト)                      │
│  │   ├─ KHK判定                                              │
│  │   ├─ YouTube/紹介動画 優先表示                             │
│  │   └─ 放送開始日時 カウントダウン                           │
│  └─ ProductGrid (通常プロダクト一覧)                          │
│                                                              │
│  新規コンポーネント:                                          │
│  ├─ FeaturedKHKProduct.tsx (おすすめKHKプロダクト)            │
│  └─ YouTubeEmbed.tsx (YouTube埋め込み)                       │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                     API Routes                               │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  GET /api/products/khk                                       │
│  └─ KHKで公開=trueのプロダクトを取得                          │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                     lib/product-client.ts                    │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  新規追加:                                                    │
│  ├─ KHKで公開フィールド対応                                   │
│  ├─ YouTubeLinkフィールド対応                                │
│  ├─ 放送開始日時フィールド対応                                │
│  └─ getKHKProducts() 関数                                    │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│                     LarkBase (多元表)                        │
│                     開発テーブル                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 画面仕様

### 7.1 おすすめプロダクト表示（Phase 1）

```
┌──────────────────────────────────────────────┐
│  ★ おすすめプロダクト                          │
├──────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐   │
│ │                                        │   │
│ │     [YouTube埋め込み or 紹介動画]       │   │
│ │           (16:9 アスペクト比)           │   │
│ │                                        │   │
│ └────────────────────────────────────────┘   │
│                                              │
│ [公開中] プロダクト名                          │
│ プロダクト説明文...                           │
│                                              │
└──────────────────────────────────────────────┘
```

### 7.2 放送開始前表示（Phase 2）

```
┌──────────────────────────────────────────────┐
│  ★ おすすめプロダクト                          │
├──────────────────────────────────────────────┤
│ ┌────────────────────────────────────────┐   │
│ │                                        │   │
│ │     [プレースホルダー画像]              │   │
│ │                                        │   │
│ │     放送開始まで: 01:23:45             │   │
│ │     2024年1月15日 19:00〜              │   │
│ │                                        │   │
│ └────────────────────────────────────────┘   │
│                                              │
│ [まもなく開始] プロダクト名                    │
│ プロダクト説明文...                           │
│                                              │
└──────────────────────────────────────────────┘
```

---

## 8. 実装タスク一覧

### Phase 1: KHK公開フィルタリング

| ID | タスク | 担当 | 優先度 |
|----|--------|------|--------|
| T1-1 | product-client.ts: 新フィールド対応 | CodeGenAgent | 高 |
| T1-2 | Product型定義の更新 | CodeGenAgent | 高 |
| T1-3 | GET /api/products/khk エンドポイント作成 | CodeGenAgent | 高 |
| T1-4 | YouTubeEmbed.tsx コンポーネント作成 | CodeGenAgent | 高 |
| T1-5 | FeaturedKHKProduct.tsx コンポーネント作成 | CodeGenAgent | 高 |
| T1-6 | HomeClient.tsx 統合 | CodeGenAgent | 高 |
| T1-7 | テスト実装 | ReviewAgent | 中 |

### Phase 2: 放送開始日時による動画切り替え

| ID | タスク | 担当 | 優先度 |
|----|--------|------|--------|
| T2-1 | 放送開始日時フィールド対応 | CodeGenAgent | 中 |
| T2-2 | カウントダウンロジック実装 | CodeGenAgent | 中 |
| T2-3 | リアルタイム切り替え実装 | CodeGenAgent | 中 |
| T2-4 | UI更新（放送前/放送中表示） | CodeGenAgent | 中 |
| T2-5 | 統合テスト | ReviewAgent | 中 |

---

## 9. 変更履歴

| 日付 | バージョン | 変更内容 | 担当者 |
|------|-----------|----------|--------|
| 2026-01-14 | 1.0 | 初版作成 | Claude Code |

---

## 10. 承認

| 役割 | 名前 | 日付 | 署名 |
|------|------|------|------|
| プロダクトオーナー | | | |
| 技術リード | | | |
