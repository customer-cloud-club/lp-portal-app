# ADreamFactory Portal システムアーキテクチャ

## 1. システム全体図

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              ADreamFactory Portal                                    │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            Frontend Layer (Next.js 15)                          │ │
│  │                                                                                 │ │
│  │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐│ │
│  │   │   ホーム     │  │  イベント   │  │   ライブ    │  │        管理画面         ││ │
│  │   │   画面      │  │   詳細      │  │   配信      │  │                        ││ │
│  │   │            │  │            │  │            │  │  ・コンテンツ管理       ││ │
│  │   │ ・おすすめ  │  │ ・動画再生  │  │ ・HLS配信   │  │  ・ユーザー管理         ││ │
│  │   │ ・KHK公開   │  │ ・詳細情報  │  │ ・チャット  │  │  ・アナリティクス       ││ │
│  │   │ ・一覧表示  │  │ ・特典      │  │            │  │                        ││ │
│  │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────────────┘│ │
│  │                                                                                 │ │
│  │   ┌─────────────────────────────────────────────────────────────────────────┐   │ │
│  │   │                    Shared Components                                    │   │ │
│  │   │                                                                         │   │ │
│  │   │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐    │   │ │
│  │   │  │ EventCard    │ │ VideoPlayer  │ │ SearchBar    │ │ UserMenu     │    │   │ │
│  │   │  │              │ │              │ │              │ │              │    │   │ │
│  │   │  │ KHKFeatured  │ │ YouTube      │ │ Category     │ │ BottomNav    │    │   │ │
│  │   │  │ Section      │ │ Embed        │ │ Filter       │ │              │    │   │ │
│  │   │  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘    │   │ │
│  │   └─────────────────────────────────────────────────────────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                            │
│                                         ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐ │
│  │                            API Layer (Next.js API Routes)                       │ │
│  │                                                                                 │ │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │ │
│  │   │ /api/events  │  │/api/khk-     │  │ /api/archive │  │ /api/auth    │        │ │
│  │   │              │  │ featured     │  │              │  │              │        │ │
│  │   │ ・一覧取得   │  │              │  │ ・動画取得   │  │ ・Discord    │        │ │
│  │   │ ・詳細取得   │  │ ・KHK公開    │  │ ・URL生成    │  │ ・セッション │        │ │
│  │   │ ・フィルター │  │  コンテンツ  │  │              │  │              │        │ │
│  │   └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘        │ │
│  │                                                                                 │ │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                         │ │
│  │   │/api/lark-    │  │/api/lark-    │  │ /api/push    │                         │ │
│  │   │ image        │  │ video        │  │              │                         │ │
│  │   │              │  │              │  │ ・通知送信   │                         │ │
│  │   │ ・画像プロキシ│  │ ・動画プロキシ│  │ ・購読管理   │                         │ │
│  │   └──────────────┘  └──────────────┘  └──────────────┘                         │ │
│  └─────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                            │
└─────────────────────────────────────────┼────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              External Services                                       │
│                                                                                      │
│   ┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐       │
│   │      LarkBase       │   │     Lark Drive      │   │       Discord       │       │
│   │     (多元表/DB)     │   │    (ストレージ)      │   │       (認証)        │       │
│   │                     │   │                     │   │                     │       │
│   │  ・イベント情報     │   │  ・動画ファイル     │   │  ・OAuth2           │       │
│   │  ・KHK公開フラグ    │   │  ・サムネイル       │   │  ・ロール管理       │       │
│   │  ・放送開始日時     │   │  ・資料             │   │  ・メンバー確認     │       │
│   │  ・カテゴリ         │   │                     │   │                     │       │
│   └─────────────────────┘   └─────────────────────┘   └─────────────────────┘       │
│                                                                                      │
│   ┌─────────────────────┐   ┌─────────────────────┐                                 │
│   │      YouTube        │   │       Stripe        │                                 │
│   │     (動画配信)      │   │       (決済)        │                                 │
│   │                     │   │                     │                                 │
│   │  ・埋め込み再生     │   │  ・サブスク管理     │                                 │
│   │  ・ライブ配信       │   │  ・Webhook          │                                 │
│   └─────────────────────┘   └─────────────────────┘                                 │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. データフロー

### 2.1 KHK公開コンテンツ表示フロー

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        KHK公開コンテンツ表示フロー                                   │
│                                                                                      │
│   ┌─────────────┐                                                                   │
│   │   ユーザー   │                                                                   │
│   │   ブラウザ   │                                                                   │
│   └──────┬──────┘                                                                   │
│          │ 1. ホーム画面アクセス                                                     │
│          ▼                                                                          │
│   ┌─────────────┐    2. KHKコンテンツ取得                                           │
│   │  HomeClient │ ─────────────────────────────────────────┐                        │
│   │  .tsx       │                                          │                        │
│   └──────┬──────┘                                          ▼                        │
│          │                                          ┌─────────────┐                 │
│          │                                          │/api/khk-    │                 │
│          │                                          │featured     │                 │
│          │                                          └──────┬──────┘                 │
│          │                                                 │                        │
│          │                                                 ▼                        │
│          │                                          ┌─────────────┐                 │
│          │         3. LarkBase API呼び出し          │ larkbase-   │                 │
│          │         ←─────────────────────────────── │ client.ts   │                 │
│          │                                          └──────┬──────┘                 │
│          │                                                 │                        │
│          │                                                 ▼                        │
│          │                                          ┌─────────────┐                 │
│          │         4. KHK公開=trueでフィルタ        │  LarkBase   │                 │
│          │         ←─────────────────────────────── │   多元表    │                 │
│          │                                          └─────────────┘                 │
│          │                                                                          │
│          ▼                                                                          │
│   ┌─────────────┐                                                                   │
│   │ KHKFeatured │  5. 表示判定                                                      │
│   │ Section     │                                                                   │
│   └──────┬──────┘                                                                   │
│          │                                                                          │
│          ├─── YouTubeリンクあり → YouTubeEmbed表示                                  │
│          │                                                                          │
│          └─── YouTubeリンクなし                                                     │
│               └─── 紹介動画あり → IntroVideoPlayer表示                              │
│                    └─── 両方なし → 非表示                                           │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 放送開始日時制御フロー（Phase 2）

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                        放送開始日時制御フロー                                        │
│                                                                                      │
│   ┌─────────────┐                                                                   │
│   │ KHKFeatured │                                                                   │
│   │ Section     │                                                                   │
│   └──────┬──────┘                                                                   │
│          │                                                                          │
│          ▼                                                                          │
│   ┌──────────────────────────────────────────────────────────────────────────┐      │
│   │                    放送開始日時チェック                                   │      │
│   │                                                                          │      │
│   │   broadcast_start_at の値を確認                                          │      │
│   │                                                                          │      │
│   └───────────────────────────┬─────────────────────────────────────────────┘      │
│                               │                                                     │
│           ┌───────────────────┼───────────────────┐                                 │
│           │                   │                   │                                 │
│           ▼                   ▼                   ▼                                 │
│   ┌───────────────┐   ┌───────────────┐   ┌───────────────┐                        │
│   │ 未設定        │   │ 未来日時      │   │ 過去日時      │                        │
│   │               │   │               │   │               │                        │
│   │ 即時公開      │   │ カウントダウン │   │ 通常表示      │                        │
│   │ 動画表示      │   │ 表示          │   │ 動画再生可    │                        │
│   └───────────────┘   └───────┬───────┘   └───────────────┘                        │
│                               │                                                     │
│                               ▼                                                     │
│                       ┌───────────────┐                                             │
│                       │ Broadcast     │                                             │
│                       │ Countdown     │                                             │
│                       │               │                                             │
│                       │ ・残り時間表示│                                             │
│                       │ ・1秒更新     │                                             │
│                       │ ・開始時自動  │                                             │
│                       │  切り替え     │                                             │
│                       └───────────────┘                                             │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. コンポーネント構成

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              コンポーネント階層                                      │
│                                                                                      │
│   app/                                                                              │
│   ├── page.tsx (Server Component)                                                   │
│   │   └── HomeClient.tsx (Client Component)                                         │
│   │       ├── Header                                                                │
│   │       │   ├── Logo                                                              │
│   │       │   ├── NotificationLink                                                  │
│   │       │   ├── LiveBadge                                                         │
│   │       │   └── UserMenu                                                          │
│   │       │                                                                         │
│   │       ├── SearchBar                                                             │
│   │       ├── CategoryFilter                                                        │
│   │       │                                                                         │
│   │       ├── KHKFeaturedSection ★ NEW                                              │
│   │       │   ├── YouTubeEmbed                                                      │
│   │       │   ├── IntroVideoPlayer                                                  │
│   │       │   ├── BroadcastCountdown (Phase 2)                                      │
│   │       │   └── CarouselIndicator                                                 │
│   │       │                                                                         │
│   │       ├── FeaturedSection (fallback)                                            │
│   │       │                                                                         │
│   │       ├── RecentArchivesSection                                                 │
│   │       │                                                                         │
│   │       ├── EventsGrid                                                            │
│   │       │   └── EventCard (multiple)                                              │
│   │       │                                                                         │
│   │       ├── InfiniteScrollLoader                                                  │
│   │       │                                                                         │
│   │       └── BottomNavigation                                                      │
│   │                                                                                 │
│   └── events/[id]/                                                                  │
│       └── page.tsx                                                                  │
│           ├── EventHeader                                                           │
│           ├── VideoSection                                                          │
│           ├── EventDetails                                                          │
│           └── BenefitsSection                                                       │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. LarkBaseフィールドマッピング

### 4.1 既存フィールド

| LarkBaseフィールド名 | 型 | Event型プロパティ | 説明 |
|---------------------|-----|------------------|------|
| イベントタイトル | テキスト | title | イベント名 |
| イベント概要 | 複数行テキスト | description | 説明文 |
| イベント開始日時 | 日時 | scheduled_at | 開催日時 |
| イベント終了日時 | 日時 | scheduled_end_at | 終了日時 |
| カテゴリ | 複数選択 | categories | カテゴリ配列 |
| サムネイル | 添付ファイル | thumbnail | サムネイル画像 |
| セミナーURL | リンク | seminar_url | セミナー/アーカイブURL |
| YouTube URL | テキスト | youtube_url | YouTube動画URL |
| アーカイブ動画 | リンク | archive_url | アーカイブ動画URL |
| 登壇者 | ユーザー | speaker.name | 登壇者名 |
| 時間（分） | 数値 | duration | 再生時間 |

### 4.2 KHK機能用新規フィールド

| LarkBaseフィールド名 | 型 | Event型プロパティ | 説明 |
|---------------------|-----|------------------|------|
| KHKで公開 | チェックボックス | khk_published | KHK公開フラグ |
| YouTubeリンク | テキスト/リンク | khk_youtube_url | KHK用YouTube URL |
| 紹介動画 | 添付ファイル | khk_intro_video_token | 紹介動画ファイル |
| 放送開始日時 | 日時 | broadcast_start_at | スケジュール配信開始 |

---

## 5. API設計

### 5.1 エンドポイント一覧

| エンドポイント | メソッド | 説明 | レスポンス |
|---------------|---------|------|-----------|
| `/api/events` | GET | イベント一覧取得 | Event[] |
| `/api/events/[id]` | GET | イベント詳細取得 | Event |
| `/api/khk-featured` | GET | KHK公開コンテンツ取得 | KHKEvent[] |
| `/api/archive/[id]` | GET | アーカイブ動画URL取得 | { url: string } |
| `/api/lark-image` | GET | 画像プロキシ | Image binary |
| `/api/lark-video` | GET | 動画プロキシ | Video stream |
| `/api/auth/[...nextauth]` | * | 認証 | Session |

### 5.2 /api/khk-featured レスポンス

```typescript
interface KHKFeaturedResponse {
  success: boolean;
  events: {
    id: string;
    title: string;
    description: string;
    video_type: 'youtube' | 'intro';
    video_url?: string;
    video_token?: string;
    thumbnail?: string;
    broadcast_start_at?: string;
    is_live: boolean;
  }[];
  total: number;
}
```

---

## 6. デプロイメント構成

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              デプロイメント構成                                      │
│                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────┐   │
│   │                         Cloudflare Workers                                  │   │
│   │                                                                             │   │
│   │   ┌─────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                    OpenNext Adapter                                 │   │   │
│   │   │                                                                     │   │   │
│   │   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │   │   │
│   │   │   │  SSR Handler    │  │  API Routes     │  │  Static Assets  │    │   │   │
│   │   │   │                 │  │                 │  │                 │    │   │   │
│   │   │   │  React Server   │  │  Edge Runtime   │  │  _next/static   │    │   │   │
│   │   │   │  Components     │  │                 │  │                 │    │   │   │
│   │   │   └─────────────────┘  └─────────────────┘  └─────────────────┘    │   │   │
│   │   │                                                                     │   │   │
│   │   └─────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                             │   │
│   │   CDN: Cloudflare Edge Network                                              │   │
│   │   Cache: 60秒 (revalidate)                                                   │   │
│   │                                                                             │   │
│   └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│   ┌───────────────────────┐   ┌───────────────────────┐                             │
│   │    開発環境 (local)   │   │    本番環境            │                             │
│   │                       │   │                       │                             │
│   │    npm run dev        │   │    npm run deploy     │                             │
│   │    localhost:3000     │   │    *.workers.dev      │                             │
│   └───────────────────────┘   └───────────────────────┘                             │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. セキュリティ

### 7.1 認証フロー

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Discord OAuth2 認証フロー                               │
│                                                                                      │
│   ┌─────────────┐    1. ログイン開始     ┌─────────────┐                            │
│   │   ユーザー   │ ───────────────────▶  │  NextAuth   │                            │
│   └─────────────┘                        └──────┬──────┘                            │
│                                                 │                                   │
│                                                 │ 2. Discord認証へリダイレクト       │
│                                                 ▼                                   │
│                                          ┌─────────────┐                            │
│                                          │   Discord   │                            │
│                                          │   OAuth2    │                            │
│                                          └──────┬──────┘                            │
│                                                 │                                   │
│                                                 │ 3. 認証コードでコールバック        │
│                                                 ▼                                   │
│   ┌─────────────┐    4. セッション作成   ┌─────────────┐                            │
│   │   ユーザー   │ ◀──────────────────   │  NextAuth   │                            │
│   │  (認証済み)  │                        │             │                            │
│   └─────────────┘                        │ 5. ロール   │                            │
│                                          │    確認     │                            │
│                                          └──────┬──────┘                            │
│                                                 │                                   │
│                                                 ▼                                   │
│                                          ┌─────────────┐                            │
│                                          │   Discord   │                            │
│                                          │   Guild API │                            │
│                                          └─────────────┘                            │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 アクセス制御

| コンテンツタイプ | 認証要否 | 条件 |
|----------------|---------|------|
| KHK公開コンテンツ | 不要 | khk_published=true |
| 通常イベント一覧 | 不要 | 公開設定=public |
| 会員限定コンテンツ | 必要 | visibility=members-only |
| アーカイブ動画視聴 | 必要 | Discord会員ロール |
| 管理画面 | 必要 | 管理者ロール |

---

## 8. 技術スタック

| カテゴリ | 技術 | バージョン |
|---------|-----|----------|
| フレームワーク | Next.js | 15.0.3 |
| UI | React | 19.x |
| 言語 | TypeScript | 5.x |
| スタイリング | Tailwind CSS | 4.x |
| 認証 | NextAuth.js | 4.x |
| データベース | LarkBase | API v1 |
| ストレージ | Lark Drive | API v1 |
| デプロイ | Cloudflare Workers | - |
| テスト | Vitest | 3.x |

---

*このドキュメントは開発進行に応じて更新されます。*
